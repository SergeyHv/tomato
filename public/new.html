<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üçÖ DEBUG MODE: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
<div id="app" class="flex flex-col md:flex-row h-screen overflow-hidden">

  <aside class="w-full md:w-1/3 bg-white border-r flex flex-col h-1/2 md:h-full">
    <div class="p-4 border-b">
      <h1 class="text-xl font-bold text-red-600">üçÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è (Debug On)</h1>
      <input v-model="search" placeholder="–ü–æ–∏—Å–∫..." class="w-full mt-2 p-2 border rounded-lg">
    </div>
    <div class="flex-1 overflow-y-auto p-2 space-y-2">
      <div v-for="p in filtered" :key="p.id" class="p-3 bg-white border rounded-xl flex items-center gap-3 shadow-sm">
        <img :src="p.images" class="w-10 h-10 rounded object-cover bg-gray-100">
        <div class="flex-1 font-bold text-sm truncate">{{ p.title }}</div>
        <button @click="edit(p)" class="text-blue-500 text-xs">‚úèÔ∏è</button>
        <button @click="remove(p.id)" class="text-red-500 text-xs">üóë</button>
      </div>
    </div>
  </aside>

  <main class="flex-1 p-6 overflow-y-auto bg-gray-50">
    <div class="max-w-lg mx-auto bg-white p-8 rounded-3xl shadow-lg">
      <h2 class="text-2xl font-bold mb-6">{{ editId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å' }}</h2>
      
      <form @submit.prevent="save" class="space-y-4">
        <input v-model="form.title" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="w-full p-3 border rounded-xl">
        
        <select v-model="form.category" class="w-full p-3 border rounded-xl">
          <option value="Dwarf">–ì–Ω–æ–º</option>
          <option value="Det">–ù–∏–∑–∫–∏–π</option>
          <option value="Indet">–í—ã—Å–æ–∫–∏–π</option>
        </select>

        <input type="file" @change="pickImage" class="w-full text-sm">
        <img v-if="preview" :src="preview" class="w-full h-40 object-cover rounded-xl border">

        <button type="submit" :disabled="saving" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold">
           {{ saving ? '‚è≥ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø...' : 'üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ú–ì–ù–û–í–ï–ù–ù–û' }}
        </button>
      </form>

      <div class="mt-10 p-4 bg-black text-green-400 text-xs font-mono rounded-xl overflow-hidden">
        <div class="uppercase mb-2 border-b border-green-900 pb-1">Console Debug:</div>
        <div v-for="log in logs" :key="log.t">{{ log.m }}</div>
      </div>
    </div>
  </main>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      products: [], search: '', editId: null, saving: false,
      preview: '', imageBase64: '', logs: [],
      form: { title: '', category: 'Dwarf' }
    };
  },
  computed: {
    filtered() {
      return this.products.filter(p => p.title.toLowerCase().includes(this.search.toLowerCase()));
    }
  },
  methods: {
    addLog(m) {
      this.logs.unshift({ t: Date.now(), m: `> ${m}` });
      console.log(m);
    },
    async load() {
      this.addLog("–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞...");
      const r = await fetch('/api/admin/get-products');
      this.products = await r.json();
      this.addLog(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${this.products.length} —Å–æ—Ä—Ç–æ–≤`);
    },
    edit(p) {
      this.editId = p.id;
      this.form = { ...p };
      this.preview = p.images;
      this.addLog(`–†–µ–∂–∏–º –ø—Ä–∞–≤–∫–∏: ${p.title}`);
    },
    pickImage(e) {
      const f = e.target.files[0];
      const r = new FileReader();
      r.onload = ev => { this.preview = ev.target.result; this.imageBase64 = ev.target.result; };
      r.readAsDataURL(f);
      this.addLog("–§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ");
    },
    async save() {
      this.addLog("–ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞: –°–¢–ê–†–¢");
      this.saving = true;

      const tempId = this.editId || `t_${Date.now()}`;
      const newEntry = { id: tempId, title: this.form.title, category: this.form.category, images: this.preview };

      // --- –ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê (–ë–ï–ó –û–ñ–ò–î–ê–ù–ò–Ø –°–ï–†–í–ï–†–ê) ---
      if (this.editId) {
        const idx = this.products.findIndex(p => p.id === tempId);
        this.products[idx] = newEntry;
      } else {
        this.products.unshift(newEntry);
      }
      this.addLog("UI –æ–±–Ω–æ–≤–ª–µ–Ω –º–≥–Ω–æ–≤–µ–Ω–Ω–æ");

      // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      const payload = { ...this.form, id: tempId, images: this.preview, imageBase64: this.imageBase64 };
      
      // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å—Ä–∞–∑—É
      this.editId = null;
      this.form = { title: '', category: 'Dwarf' };
      this.preview = '';

      // --- –§–û–ù–û–í–ê–Ø –û–¢–ü–†–ê–í–ö–ê (–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è) ---
      this.addLog("–§–æ–Ω–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Google Sheets...");
      
      // –ú—ã –ù–ï –ø–∏—à–µ–º await –ø–µ—Ä–µ–¥ fetch, —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å—Ä–∞–∑—É!
      this.sendToServer(payload);
      
      this.saving = false;
      this.addLog("–ö–Ω–æ–ø–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, —Ä–∞–±–æ—Ç–∞–µ–º –¥–∞–ª—å—à–µ");
    },

    async sendToServer(payload) {
      try {
        let finalUrl = payload.images;
        if (payload.imageBase64) {
          const up = await fetch('/api/admin/upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: `img_${Date.now()}.jpg`, base64: payload.imageBase64 })
          });
          finalUrl = (await up.json()).url;
          this.addLog("–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ Blob");
        }

        await fetch('/api/admin/add-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...payload, images: finalUrl, password: 'khvalla74' })
        });
        this.addLog("‚úÖ Google Sheets –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∑–∞–ø–∏—Å—å");
      } catch (e) {
        this.addLog("‚ùå –û–®–ò–ë–ö–ê –°–ï–†–í–ï–†–ê: " + e.message);
      }
    },

    async remove(id) {
      this.addLog(`–£–¥–∞–ª–µ–Ω–∏–µ ID: ${id}`);
      this.products = this.products.filter(p => p.id !== id);
      
      fetch('/api/admin/delete-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, password: 'khvalla74' })
      }).then(() => this.addLog("‚úÖ –£–¥–∞–ª–µ–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü–µ"));
    }
  },
  mounted() { this.load(); }
}).mount('#app');
</script>
</body>
</html>
